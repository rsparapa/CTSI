\documentclass[11pt,pdftex,dvipsnames,usenames]{beamer}
\setbeameroption{show notes}
%\usepackage[round]{natbib}
%\usepackage{amsmath}
%\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{hyperref}
\DeclareGraphicsExtensions{.ps,.eps,.pdf,.jpg,.png}
\usefonttheme[onlymath]{serif}
%\usepackage[cmintegrals,cmbraces]{newtxmath}
\usetheme{default}
\usecolortheme{dove}

%\usepackage{cancel}
%\usepackage{tikz}
%\usepackage[english]{babel}
\usepackage{statex2}
\usepackage{verbatim}
\usepackage{color}
%\usepackage{pgf} %portable graphics format
%\usepackage[autobold]{statex2}
%\usepackage{enumitem}
\mode<presentation>
{
  %\usetheme{Warsaw}
  % or ...
  \setbeamercovered{transparent}
  % or whatever (possibly just delete it)

  \setbeamertemplate{navigation symbols}{}
  \usefonttheme[onlysmall]{structurebold}
  %\usefonttheme{structurebold}
}
\addtobeamertemplate{navigation symbols}{}{%
    \usebeamerfont{footline}%
  \setbeamertemplate{navigation symbols}{}
    \usebeamercolor[fg]{footline}%
    \hspace{1em}%
    \insertframenumber/\inserttotalframenumber
}
% \newcommand*{\BART}{\mathrm{BART}\ }
% \newcommand*{\Wei}[2]{\mathrm{Wei}\wrap[()]{#1, #2}}
% \newcommand*{\HBART}{\mathrm{HBART}\ }
% \newcommand*{\corr}{\mathrm{corr}}
% \newcommand*{\abs}{\mathrm{abs}}
% \newcommand*{\DP}[2]{\mb{\mathrm{DP}}\wrap[()]{\mb{#1,\ #2}}}
%\newcommand*{\EV}[2]{\mb{\mathrm{ExtremeValue}}\wrap[()]{\mb{#1,\ #2}}}
%\newcommand*{\Wei}[2]{\mathrm{Wei}\wrap[()]{#1, #2}}

\title{An introduction to big data mining of electronic health records with
Jupyterhub, R, SQL and SAS}
\author{Kristen Osinski, Rodney Sparapani and Bradley Taylor}

\begin{document}
\bibliographystyle{plainnat}

\titlepage
\boldmath
% 0. Intro

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Schedule}}

\begin{tabular}{rl}
8:00 & Speaker/attendee introductions \\
8:15 & Bradley Taylor, Chief Research Informatics Officer \\
8:30 & Kristen Osinski, Business Analyst IV, CTSI \\
9:15 & CRDW, Jupyterhub, SQL and R \\
10:00& Coffee break getting to know each other \\
10:30& Hands-on with Jupyterhub  \\
12:00& Lunch on your own \\
12:30& Case study: Cardio-oncology \\
2:00 & Biological break \\
2:15 & SAS and RASMACRO \\
4:00 & Q and A \\
4:15 & 
\end{tabular}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Outline}}

\begin{itemize}
\item Overview
\item Background
\item Timeline
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Overview}}

\begin{itemize}
\item CTSI Clinical Research Data Warehouse (CRDW)
%\item We restrict our attention on the following matters
\item Adult patient records at Froedtert and MCW
\item Jupyterhub access to the CRDW for adults
\item Collaborative Institutional Training Initiative (CITI) training
\item SQL, R and SAS: popular and mature programming languages
\item SQL and R come free with Jupyterhub
\item SAS can be purchased through the MCW IS Ticket system\\
 for Windows client (free for students) and Linux server 
\item \textcolor{PineGreen}{[\href{https://mcwcherwellapp.mcwcorp.net/CherwellPortal}{https://mcwcherwellapp.mcwcorp.net/CherwellPortal}]}
\item In this presentation, links are colored \textcolor{PineGreen}{[green]}
and surrounded by square brackets for color equity

% \item On the TIOBE Index of programming language popularity (circa 04/22)
% \item Structured Query Language (SQL) is number 9 \\ first appeared in 1974
% \item R is number 11 \\
% derivative of S which first appeared in 1976
% \item SAS is number 21 \\
% first appeared in 1972
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Timeline of CRDW data availability}}

\begin{itemize}
\item 1989: North American Association of Central Cancer Registries (NAACCR)
\item 1999 to 2018, November: GE/IDX billing
\item 2001: NAACCR for St.\ Joseph's West Bend
%\item 2003: Philips IntelliSpace Cardiovascular/Xcelera for echos
\item 2004: EPIC EHR debuts at Froedtert
\item 2005: GE/MUSE for EKGs
\item 2005 to 2007: National Provider Identifiers (NPI) transition
\item 2012, May: EPIC EHR Community Memorial Menominee Falls
\item 2013, September: EPIC EHR St.\ Joseph's
\item \textcolor{red}{2013, July: EPIC EHR for Community Physicians Clinics} 
\item 2015: Elekta/MOSAIQ radiotherapy dosage
\item \textcolor{blue}{2015, October: ICD-10 era begins}
\item 2020, March: COVID-19 pandemic declared
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Resources}}

\begin{itemize}
\item \textcolor{PineGreen}{[\href{https://ctsi.mcw.edu/investigator/services/ctsi-mini-grants/biostatistical-consultation}
{Biostatistical Consultation Mini-grants}]}
\item \textcolor{PineGreen}{[\href{https://www.mcw.edu/departments/biostatistics/biostatistics-consulting-service}{Biostatistics Consulting Service (BCS)}]}
\item \textcolor{PineGreen}{[\href{https://ctri.mcw.edu/resources/bmi-links}{CTSI Biomedical Informatics links}]}
\item \textcolor{PineGreen}{[\href{https://ctri.mcw.edu/wp-content/uploads/CTSI-Honest-Broker-Data-Dictionary.pdf}{CTSI Honest Broker Data Dictionary}]}
\item \textcolor{PineGreen}{[\href{https://www.nber.org/research/data/icd-9-cm-and-icd-10-cm-and-icd-10-pcs-crosswalk-or-general-equivalence-mappings}
{Centers for Medicare and Medicaid Services ICD-9/ICD-10 crosswalk}]}
\item \textcolor{PineGreen}{[\href{https://icd10cmtool.cdc.gov}
{US CDC ICD-10-CM Browser}]}
\item \textcolor{PineGreen}{[\href{https://en.wikipedia.org/wiki/Project_Jupyter}{Project Jupyter}]}
\item CRDW Jupyterhub \textcolor{PineGreen}{[\href{https://jupyter.ctsi.mcw.edu}{https://jupyter.ctsi.mcw.edu}]}
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Honest Broker}}

\begin{itemize}
\item What is an {\it honest broker}?
\item
``A neutral intermediary ... between the individual whose ... data are being studied, and the researcher. The honest broker collects and collates pertinent information ... replaces identifiers with a code, and releases only coded information to the researcher.''
 \textcolor{PineGreen}{[\href{https://www.hhs.gov/ohrp/sachrp-committee/recommendations/2011-october-13-letter-attachment-d/index.html}{US
     HHS FAQ}]}
\item CTSI Biomedical Informatics is the Honest Broker!
\item The term originated in diplomacy meaning an entity
accepted by all sides in a negotiation as impartial
\item German Chancellor Otto von Bismarck was the first to use the
  term, by applying it to himself, as an intermediary in negotiations
  between Russia and the Ottoman Empire (Auray-Blais and Patenaude,
  BMC Medical Ethics 2006)
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{De-identification}}

\begin{itemize}
\item All HIPAA identifiers are de-identified by the Honest Broker
\item For example, patient names, etc.\ are removed
\item Spatially, we have state of residence and\\
ZIP code is shortened to 3 digits 
\item The Medical Record Number (MRN) is replaced by
the variable \textcolor{red}{\texttt{patient\_hash}} which is a double
encrypted key 
\item \textcolor{red}{\texttt{patient\_hash}} is unchanging so that
the MRNs could be retrieved if you have IRB approval for identified
data
\item All dates for each patient are de-identified by a\\
\textcolor{blue}{single} random integer from -10 to 10 (with zero excluded)

\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Death and Cause
      of Death}}

\begin{itemize}
\item Death is available
\item However, it may not be trustworthy
\item It is common to see EMR data far beyond the death date
\item Also, Cause of Death is not available
\item It can be acquired from the state of Wisconsin\\
or the US CDC National Death Index (NDI)
\item Typically, NDI is about two years behind
\item Complete data for 2020 was released in 01/2022
\item Early release for 2021 in 01/2022 was about 98\% complete 
\item Of course, it costs money
\item And the caveats about cause of death are substantial
\item \textcolor{PineGreen}{[\href{https://www.cdc.gov/nchs/ndi/index.htm}
{US CDC NDI}]}
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Comma Separated Values}}

\begin{itemize}
\item A data exchange format that goes back to the early 1970's
\item Popularized by spreadsheets in the 80's and 90's
\item What we have today was solidifed by about 2005 
\item Standards include RFCs 4180 and 7111 among others
\item See \textcolor{PineGreen}{[\href{https://en.wikipedia.org/wiki/Comma-separated_values}
{``Comma-separated values'' on Wikipedia}]}
\item Typically, a three-letter file type of ``csv'',
e.g., ``Book1.csv''
\item A text file where each field is separated by commas
\item A missing value is nothing: two consecutive commas
\item Fields with commas are encased in double-quotes
\item Double-quotes are escaped by doubling them (like SAS does)
\item Double-quotes around numbers (or anything) is read as text 
\item Although, a standard there are edge cases that can't be
  {\it automatically} read by common software such as R and/or SAS
\item Furthermore, spreadsheets are very lax: columns can be a mixture of numbers and text that will cause havoc when read
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Comma Separated Values}}

\begin{itemize}
\item If CSV files have so many challenges, then why bother?
\item No other data exchange formats have caught on
\item Alternatives like XML are even worse!
\item With respect to CSV, SAS fills an important niche
\item SAS makes the exchange of CSV files with dates, times
and date-times effectively trivial
\item This is a very important concern since the EHR is rife
with chronological info: so much so that you don't even want to
consider making their transfer manual in any shape or form
\item And we have decades of experience with CSVs
\item Largely automated functions roughly in order of usefulness
\item SAS: \texttt{PROC IMPORT}/\texttt{PROC EXPORT}
\item R functions: \texttt{read.csv()}/\texttt{write.csv()}
\item RASMACRO: \texttt{\_cimport}/\texttt{\_cexport}\\
plus \texttt{\_crepair}, \texttt{\_constant}
and \texttt{\_verify} for handy features
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{A brief introduction to SQL}}

\begin{itemize}
\item Structured Query Language (SQL) 
\item The syntax/semantics for interacting with\\
relational database management systems
\item Originally developed by IBM: now an industry standard
\item \textcolor{PineGreen}{[\href{https://www.iso.org/standard/63555.html}
{SQL:2016 AKA ISO/IEC 9075:2016}]}
\item On the TIOBE Index of programming language popularity (circa 04/22)
\item SQL is ranked 9
\item First appeared in 1974
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{A brief introduction to R}}

\begin{itemize}
\item The R language is an open-source free software GNU project\\
 purpose-built for data science with {\it objects}
\item \textcolor{PineGreen}{[\href{https://R-project.org}{https://R-project.org}]}
\item \textcolor{PineGreen}{[\href{https://CRAN.R-project.org/manuals.html}{https://CRAN.R-project.org/manuals.html}]}
\item Naturally vectorized language with convenient objects such as vectors,
matrices and \textcolor{red}{\texttt{date.frame}}'s
\item On the TIOBE Index of programming language popularity (circa 04/22)
\item R is ranked 11 
\item A derivative of S which first appeared in 1976
\item Many free add-on packages
\item 18991 available on the Comprehensive R Archive Network (CRAN) (circa 04/22)
\item \textcolor{PineGreen}{[\href{https://CRAN.R-project.org}{https://CRAN.R-project.org}]}
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Accessing the database with R}}

\begin{itemize}
\item Via \textcolor{red}{\texttt{DBI}} package and the 
\textcolor{red}{\texttt{RPostgres}} backend from CRAN 
\item Use your MCWCORP credentials to login at 
\textcolor{PineGreen}{[\href{https://jupyter.ctsi.mcw.edu}{https://jupyter.ctsi.mcw.edu}]}
\item BUT YOU HAVE A SEPARATE \textcolor{blue}{\texttt{JHUSERNAME/JHPASSWORD}}
\end{itemize}
\begin{verbatim}
user="JHUSERNAME" 
password="JHPASSWORD"
library(DBI)
library(RPostgres)
db=dbConnect(
    Postgres(), 
    user=user,
    password=password,
    host="localhost", 
    port=5432, 
    dbname="fh_jupyter_hub_hbdb",
    bigint="integer"
)
\end{verbatim}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{A brief introduction to SAS}}

\begin{itemize}
\item The SAS language is a proprietary for-fee fourth-generation\\ domain-specific environment for data science
\item \textcolor{PineGreen}{[\href{https://SAS.com}{https://SAS.com}]}
\item \textcolor{PineGreen}{[\href{https://support.sas.com/en/documentation.html}{https://support.sas.com/en/documentation.html}]}
\item Convenient naturally vectorized \texttt{DATASTEP} language 
\item You don't buy SAS, you rent it annually June to May
\item MCW has a site-license: for students it is free
\item Use the IS ticket system to order
\item On the TIOBE Index of programming language popularity (circa 04/22)
\item SAS is ranked 21 
\item First appeared in 1972
\item The \texttt{RASMACRO} collection of my GPL SAS macros 
\textcolor{PineGreen}{[\href{https://github.com/rsparapa/rasmacro}{https://github.com/rsparapa/rasmacro}]}
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{A brief
introduction to SAS}}

\begin{itemize}
\item Why not just use R instead of SAS?
\item R's strengths are not within data processing
\item For example, R does not have warnings about non-unique keys
whereas SAS does (always check your \texttt{.log} !)
\item What is a unique key?
\item Suppose your SSN is unique, does that make it a unique key?
\item NO, not necessarily
\item Consider a table consisting of everyone's lifetime annual
  earnings where each row/record is a year for a given SSN?
\item What is the unique key on this table?
\item It is SSN AND year: NOT SSN alone!
\item The R function \texttt{byvalue} adds SAS-like
automatic variables but it is not the same as the real
thing with WARNINGS
\item For virtually all tables in the CRDW, the unique key
is not obvious and often surprising: SAS is much better suited to this
\item You have been forewarned
\end{itemize}

\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{RASMACRO}}
\begin{itemize}
\item SAS has a powerful macro language
\item RASMACRO is GPL library at 
\textcolor{PineGreen}{[\href{https://github.com/rsparapa/rasmacro}{https://github.com/rsparapa/rasmacro}]}
\item It is available on the Biostatistics Cheese Cluster
and the Research Computing Center cluster
\item But anyone can install it
\item Very useful to working with CRDW data 
\item \texttt{\_verify} to automatically convert {\it character} fields to numeric if possible,
i.e., some fields are unnecessarily encoded as text
\item \texttt{\_constant} automatically drops variables that are constant including missing
\item \texttt{\_crepair} for CSVs with very long variable strings, R has an esoteric format
that needs to be re-formatted so SAS can read them automatically
\end{itemize}
\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{RASMACRO}}
\begin{itemize}
\item Installing RASMACRO is fairly trivial on Windows and Linux
\item Get it from github in a directory called \texttt{rasmacro}
\end{itemize}
\texttt{git clone https://github.com/rsparapa/rasmacro.git} \\
To get updates: \texttt{cd rasmacro; git pull} \\
Add these lines to your \texttt{sasv9\_local.cfg} \\
where \texttt{RASMACRO} is the path to your directory 
\begin{verbatim}
/* ' these are single quotes as LaTeX renders them */
-sasautos ('!SASROOT/sasautos' 'RASMACRO') 
-set SASAUTOS ('!SASROOT/sasautos' 'RASMACRO')
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item Login \textcolor{PineGreen}{[\href{https://jupyter.ctsi.mcw.edu}{https://jupyter.ctsi.mcw.edu}]}
with your MCWCORP credentials, i.e., same as Outlook/etc.
\item And use your \texttt{JHUSERNAME/JHPASSWORD}
\item Shift+Enter submits the block
\end{itemize}
\begin{verbatim}
library(DBI)
library(RPostgres)
user="JHUSERNAME" 
password="JHPASSWORD"
## db object to facilitate database two-way communication
db=dbConnect(
    Postgres(), ## connect to a PostgreSQL database
    user=user,
    password=password,
    host="localhost", 
    port=5432, 
    dbname="fh_jupyter_hub_hbdb",
    bigint="integer" ## see dbConnect documentation
)
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item Which version of PostgreSQL are we running?
\item At the time of this writing, I see version \textbf{\textcolor{red}{11}}.15
\item The documentation can be found at
\textcolor{PineGreen}{[\href{https://www.postgresql.org/docs/11}
{https://www.postgresql.org/docs/\textbf{\textcolor{red}{11}}}]}
\item N.B. \textbf{\textcolor{red}{11}} stands for the major version number, e.g.,
if the software is upgraded to a newer version, then update accordingly
\end{itemize}
\begin{verbatim}
dbGetQuery(db, "select version()")
\end{verbatim}
\texttt{PostgreSQL} $\textcolor{red}{\bm{11}}$\texttt{.15 ...}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item Let's see the public database tables
\end{itemize}
\begin{verbatim}
## ' these are single quotes as LaTeX renders them
tables=dbGetQuery(db, 
       paste("select * from information_schema.tables",
             "where table_schema = 'public'")
)
print(tables$table_name)
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item Let's see the public database table columns
\end{itemize}
\begin{verbatim}
columns=dbGetQuery(db, 
       paste("select * from information_schema.columns",
             "where table_schema = 'public'")
)
str(columns)
table(columns$table_name)
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item We have created the \texttt{columns} \texttt{data.frame}
\item We used the \texttt{str} function to see its {\it structure}: \texttt{str(columns)}
\item The first four variables look like so
\end{itemize}
\begin{verbatim}
'data.frame':	671 obs. of  44 variables:
$ table_catalog : chr "fh_jupyter_hub_hbdb" ...
$ table_schema  : chr "public" "public" "public" ...
$ table_name    : chr "fh_hb_diagnosis_jupyter" ...
$ column_name   : chr "patient_hash" "encounter_hash" ...
...
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item We can quickly summarized the tables in the database
\item \texttt{table(columns\$table\_name)}
\item The counts correspond to the number of columns as we have seen from the structure of the \texttt{data.frame}
%\item Here's an edited version focusing on the most important tables
\end{itemize}
\begin{verbatim}
      fh_hb_demographics_jupyter          
                              31
         fh_hb_diagnosis_jupyter 
                              15 
fh_hb_diagnostic_results_jupyter
                              27
         fh_hb_mar_table_jupyter
                              37
  fh_hb_med_orders_table_jupyter 
                              32 
             fh_hb_procs_jupyter
                              18 
            fh_hb_vitals_jupyter 
                              11 
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item When does the NAACCR data start?
\item Above, I said 1989: how did I get that?
\item N.B. The SQL \texttt{date\_part} function is not to be confused with 
the SAS \texttt{datepart} function
\end{itemize}
\begin{verbatim}
naaccr=dbGetQuery(db, 
    paste("select",
          "date_part('year', date_of_diagnosis_shifted)",
          "as dxyear from fh_hb_naaccr_jupyter")
)
t(table(naaccr$dxyear))
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item When does the EKG data start?
\item Covered in the Appendix A of the 
\item \textcolor{PineGreen}{[\href{https://ctri.mcw.edu/wp-content/uploads/CTSI-Honest-Broker-Data-Dictionary.pdf}{CTSI Honest Broker Data Dictionary}]}
\end{itemize}
\begin{verbatim}
muse=dbGetQuery(db, 
    paste("select",
          "date_part('year',acquisition_date_shifted)",
          "as ekgyear from ekg_test_demographics")
)
t(table(muse$ekgyear))
\end{verbatim}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item The state of Wisconsin (as well as other regional entities in the US
and Canada) has a cancer registry that health care entities must
submit their data to by statuary requirements
\item \textcolor{PineGreen}{[\href{https://www.naaccr.org/data-standards-data-dictionary}
{NAACCR data dictionaries}]}
\item 
\textcolor{PineGreen}{[\href{http://datadictionary.naaccr.org/default.aspx?c=10&Version=22}
{Latest version 22}]}
\item NAACCR item 523: ICD-O-3 behavior codes \texttt{behavior\_code\_icd\_o\_3}
\item "valid codes are 0-3" is all that NAACCR specifies in their docs which leaves a lot to be desired
\item So you need the Surveillance, Epidemiology
and End Results (SEER) program docs too 
\item NCI SEER is a subset of NAACCR
regions in the US (including WI) with more carefully curated data
and better documentation!
\item \textcolor{PineGreen}{[\href{https://seer.cancer.gov/manuals/2022/SPCSM_2022_MainDoc.pdf}
{SEER Program Coding and Staging Manual}]}
\item 0: benign, 1: uncertain, 2: in situ, 3: malignant
\end{itemize}
\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item NAACCR item 400: Primary Site \texttt{site\_primary}
\item ICD-O-3 topography code, e.g., breast cancer C50
\item NAACCR item 560: \texttt{sequence\_number\_hospital}
\item Indicates the sequence of all malignant and nonmalignant
neoplasms over the lifetime of the patient
\item How many patients had their first breast cancer between
2016 and 2017?
\item The PostgreSQL manual seems to be very terse
\item But SAS has a nice description in their manual: \\
\textcolor{PineGreen}{[\href{https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/sqlproc/titlepage.htm}{SAS 9.4 SQL Procedure Userâ€™s Guide, Fourth Edition}]}
\item See the \texttt{BETWEEN} and \texttt{LIKE} operators
\end{itemize}
\begin{verbatim}
naaccr=dbGetQuery(db, 
    paste("select * from fh_hb_naaccr_jupyter",
          "where sequence_number_hospital='1' and",
          "(date_part('year', date_of_diagnosis_shifted)",
          "between 2016 and 2017) and",
          "site_primary like 'C50%'"))
addmargins(table(naaccr$site_primary))
\end{verbatim}
\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{Hands-on with Jupyterhub}}
\begin{itemize}
\item But, how many of these are malignant?
\item Notice that except for the dates/times,
everything is character
\item In both R and SAS, character is more painful than numeric
values (SAS imports dates from CSV files as numeric)
\item We can export the data as a CSV with \texttt{write.csv}
\item The option \texttt{quote=FALSE} means don't use quotes
\item However, if some fields have embedded commas, then you
can't turn this option on: and we don't know if there are any
\item The \texttt{na} option determines how \texttt{NA} is handled
\item In this case, we set it to the CSV standard: \texttt{na=""}
for nothing 
\end{itemize}
\begin{verbatim}
addmargins(table(naaccr$site_primary, 
           naaccr$behavior_code_icd_o_3))
str(naaccr)
write.csv(naaccr, "naaccr.csv", row.names=FALSE, na="") 
\end{verbatim}
\end{frame}


\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{CSV processing with R}}
\begin{itemize}
\item You can download your CSV files: DEMO
\item However, due to IRB restrictions, you may not download data
for more than 9999 patients
\item And you can process them with R
\item R will convert character to numeric values where possible
\item Except that it handles dates as character by default!
\item There is no automatic detection: that is a manual process
\end{itemize}
\begin{verbatim}
> naaccr = read.csv("~/Downloads/naaccr.csv")
> str(naaccr)
\end{verbatim}

\end{frame}

\begin{frame}[fragile]\frametitle{\bf\textcolor{blue}{CSV processing with SAS}}
\begin{itemize}
\item SAS does NOT automatically convert character to numeric
\item However, the RASMACRO \texttt{\_verify} can handle that
\item SAS does automatically detect dates, times and datetimes!
\item Also, the RASMACRO \texttt{\_constant} automatically detects
variable/columns that are a constant value (including missing) and
removes them
\item In this case, the following were superfluous and removed
\item \texttt{mult\_tum\_rpt\_as\_one\_prim, multiplicity\_counter, 
cs\_tumor\_size, cs\_lymph\_nodes, cs\_mets\_at\_dx, cs\_mets\_at\_dx\_bone, 
cs\_mets\_at\_dx\_brain, cs\_mets\_at\_dx\_liver, cs\_mets\_at\_dx\_lung, 
sequence\_number\_hospital}
\end{itemize}
\begin{verbatim}
proc import datafile="~/Downloads/naaccr.csv" out=naaccr;
guessingrows=max;
run;
%_verify(data=naaccr, out=naaccr);
%_constant(data=naaccr, out=naaccr);
\end{verbatim}

\end{frame}

\end{document}

